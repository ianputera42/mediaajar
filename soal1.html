<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Pembuat Soal HOTS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading {
            animation: pulse 2s infinite;
        }
        .question-card {
            transition: all 0.3s ease;
        }
        .question-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-full">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-indigo-800 mb-2">Dashboard Pembuat Soal HOTS</h1>
            <p class="text-gray-600 text-lg">Generator Soal Berbasis Higher Order Thinking Skills</p>
        </header>

        <!-- Input Form -->
        <main class="max-w-4xl mx-auto">
            <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center">
                    <span class="bg-indigo-100 p-2 rounded-lg mr-3">üìù</span>
                    Data Pembelajaran
                </h2>
                
                <form id="questionForm" class="space-y-6">
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label for="subject" class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                            <select id="subject" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">Pilih Mata Pelajaran</option>
                                <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                                <option value="Matematika">Matematika</option>
                                <option value="IPA">IPA (Ilmu Pengetahuan Alam)</option>
                                <option value="IPS">IPS (Ilmu Pengetahuan Sosial)</option>
                                <option value="Bahasa Inggris">Bahasa Inggris</option>
                                <option value="PKn">Pendidikan Kewarganegaraan</option>
                                <option value="Seni Budaya">Seni Budaya</option>
                                <option value="PJOK">Pendidikan Jasmani</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="grade" class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                            <select id="grade" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">Pilih Kelas</option>
                                <option value="VII">VII (Tujuh)</option>
                                <option value="VIII">VIII (Delapan)</option>
                                <option value="IX">IX (Sembilan)</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label for="academicYear" class="block text-sm font-medium text-gray-700 mb-2">Tahun Ajaran</label>
                        <input type="text" id="academicYear" placeholder="Contoh: 2024/2025" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <div>
                        <label for="materialScope" class="block text-sm font-medium text-gray-700 mb-2">Cakupan Materi (Bab dan Sub Bab)</label>
                        <textarea id="materialScope" rows="4" placeholder="Contoh: Bab 3 - Teks Eksplanasi&#10;- Sub Bab 3.1: Struktur Teks Eksplanasi&#10;- Sub Bab 3.2: Ciri Kebahasaan Teks Eksplanasi" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label for="mcqCount" class="block text-sm font-medium text-gray-700 mb-2">Jumlah Soal Pilihan Ganda</label>
                            <input type="number" id="mcqCount" min="1" max="50" value="10" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        
                        <div>
                            <label for="essayCount" class="block text-sm font-medium text-gray-700 mb-2">Jumlah Soal Esai</label>
                            <input type="number" id="essayCount" min="1" max="20" value="5" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>

                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-4 px-6 rounded-lg transition duration-300 flex items-center justify-center">
                        <span id="generateText">üöÄ Generate Soal HOTS</span>
                        <div id="loadingSpinner" class="hidden ml-2">
                            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                        </div>
                    </button>
                </form>
            </div>

            <!-- API Configuration -->
            <div id="apiConfigSection" class="hidden bg-white rounded-xl shadow-lg p-8 mb-8 fade-in">
                <h3 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                    <span class="bg-purple-100 p-2 rounded-lg mr-3">üîë</span>
                    Konfigurasi API ChatGPT
                </h3>
                <div class="bg-yellow-50 rounded-lg p-4 border-l-4 border-yellow-500 mb-6">
                    <h4 class="font-semibold text-yellow-800 mb-2">‚ö†Ô∏è Penting:</h4>
                    <p class="text-sm text-yellow-700">Masukkan API Key OpenAI Anda untuk menggunakan fitur otomatis. API Key akan disimpan sementara di browser dan tidak akan dikirim ke server lain.</p>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label for="apiKey" class="block text-sm font-medium text-gray-700 mb-2">OpenAI API Key</label>
                        <div class="flex gap-2">
                            <input type="password" id="apiKey" placeholder="sk-..." class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                            <button id="toggleApiKey" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-lg transition duration-300">
                                üëÅÔ∏è
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Dapatkan API Key di: <a href="https://platform.openai.com/api-keys" target="_blank" class="text-blue-500 hover:underline">platform.openai.com/api-keys</a></p>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label for="model" class="block text-sm font-medium text-gray-700 mb-2">Model</label>
                            <select id="model" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Ekonomis)</option>
                                <option value="gpt-4">GPT-4 (Kualitas Tinggi)</option>
                                <option value="gpt-4-turbo-preview">GPT-4 Turbo (Terbaru)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="temperature" class="block text-sm font-medium text-gray-700 mb-2">Kreativitas (0-1)</label>
                            <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7" class="w-full">
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>Konservatif</span>
                                <span id="tempValue">0.7</span>
                                <span>Kreatif</span>
                            </div>
                        </div>
                    </div>
                    
                    <button id="testConnection" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300">
                        üîó Test Koneksi API
                    </button>
                </div>
            </div>

            <!-- Generation Options -->
            <div id="generationOptions" class="hidden bg-white rounded-xl shadow-lg p-8 mb-8 fade-in">
                <h3 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                    <span class="bg-green-100 p-2 rounded-lg mr-3">‚öôÔ∏è</span>
                    Opsi Generasi Otomatis
                </h3>
                
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <h4 class="font-semibold text-gray-700">Mode Generasi:</h4>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="radio" name="generationMode" value="auto" checked class="mr-2">
                                <span class="text-sm">ü§ñ Otomatis (Langsung generate)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="generationMode" value="manual" class="mr-2">
                                <span class="text-sm">üìù Manual (Tampilkan prompt)</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <h4 class="font-semibold text-gray-700">Fitur Tambahan:</h4>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="includeExplanation" checked class="mr-2">
                                <span class="text-sm">üí° Sertakan penjelasan jawaban</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="includeRubric" checked class="mr-2">
                                <span class="text-sm">üìä Sertakan rubrik penilaian</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="contextualProblem" checked class="mr-2">
                                <span class="text-sm">üåç Masalah kontekstual Indonesia</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 flex gap-4">
                    <button id="generateAuto" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-4 px-8 rounded-lg transition duration-300 flex items-center">
                        <span id="generateAutoText">üöÄ Generate Otomatis</span>
                        <div id="generateAutoSpinner" class="hidden ml-2">
                            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                        </div>
                    </button>
                    <button id="showPrompt" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-8 rounded-lg transition duration-300">
                        üìã Lihat Prompt
                    </button>
                </div>
            </div>

            <!-- Manual Prompt Display -->
            <div id="promptSection" class="hidden bg-white rounded-xl shadow-lg p-8 mb-8 fade-in">
                <h3 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                    <span class="bg-blue-100 p-2 rounded-lg mr-3">üìù</span>
                    Prompt untuk ChatGPT
                </h3>
                <div class="bg-gray-50 rounded-lg p-6 border-l-4 border-blue-500">
                    <div class="flex justify-between items-start mb-4">
                        <p class="text-sm text-gray-600 mb-2">Salin prompt berikut ke ChatGPT:</p>
                        <button id="copyPrompt" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm transition duration-300">
                            üìã Salin
                        </button>
                    </div>
                    <pre id="chatgptPrompt" class="text-sm text-gray-800 whitespace-pre-wrap font-mono bg-white p-4 rounded border overflow-x-auto"></pre>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="hidden bg-white rounded-xl shadow-lg p-8 fade-in">
                <h3 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center">
                    <span class="bg-yellow-100 p-2 rounded-lg mr-3">üìä</span>
                    Hasil Soal HOTS
                </h3>
                
                <!-- API Generation Status -->
                <div id="apiStatus" class="hidden mb-6 p-4 rounded-lg border-l-4">
                    <div class="flex items-center">
                        <div id="statusIcon" class="mr-3"></div>
                        <div>
                            <h4 id="statusTitle" class="font-semibold"></h4>
                            <p id="statusMessage" class="text-sm"></p>
                        </div>
                    </div>
                    <div id="progressBar" class="hidden mt-3 w-full bg-gray-200 rounded-full h-2">
                        <div id="progressFill" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Manual Input (fallback) -->
                <div id="manualInput" class="mb-6">
                    <label for="chatgptResult" class="block text-sm font-medium text-gray-700 mb-2">
                        Hasil dari API atau paste manual:
                    </label>
                    <textarea id="chatgptResult" rows="10" placeholder="Hasil soal akan muncul di sini secara otomatis, atau Anda bisa paste manual..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                
                <div class="flex gap-4 mb-6">
                    <button id="processResult" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300">
                        ‚ö° Proses Hasil
                    </button>
                    <button id="regenerate" class="hidden bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300">
                        üîÑ Generate Ulang
                    </button>
                    <button id="downloadPdf" class="hidden bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300">
                        üìÑ Download PDF
                    </button>
                    <button id="downloadWord" class="hidden bg-blue-800 hover:bg-blue-900 text-white font-semibold py-3 px-6 rounded-lg transition duration-300">
                        üìù Download Word
                    </button>
                </div>

                <!-- Processed Questions Display -->
                <div id="processedQuestions" class="hidden">
                    <div class="border-t pt-6">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-xl font-semibold text-gray-800">üìù Soal yang Dihasilkan</h4>
                            <div class="flex gap-2">
                                <button id="toggleView" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm transition duration-300">
                                    üëÅÔ∏è Tampilan Kompak
                                </button>
                                <button id="exportJson" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm transition duration-300">
                                    üíæ Export JSON
                                </button>
                            </div>
                        </div>
                        <div id="questionsContainer" class="space-y-6"></div>
                        
                        <!-- Statistics -->
                        <div id="questionStats" class="mt-8 grid md:grid-cols-3 gap-4">
                            <div class="bg-blue-50 p-4 rounded-lg text-center">
                                <h5 class="font-semibold text-blue-800">Total Soal</h5>
                                <p id="totalQuestions" class="text-2xl font-bold text-blue-600">0</p>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg text-center">
                                <h5 class="font-semibold text-green-800">Pilihan Ganda</h5>
                                <p id="mcqCount" class="text-2xl font-bold text-green-600">0</p>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg text-center">
                                <h5 class="font-semibold text-purple-800">Esai</h5>
                                <p id="essayCount" class="text-2xl font-bold text-purple-600">0</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- HOTS Information -->
            <div class="bg-white rounded-xl shadow-lg p-8 mt-8">
                <h3 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                    <span class="bg-purple-100 p-2 rounded-lg mr-3">üß†</span>
                    Tentang Soal HOTS
                </h3>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold text-purple-800 mb-2">Karakteristik Soal HOTS:</h4>
                        <ul class="text-sm text-gray-700 space-y-1">
                            <li>‚Ä¢ Mengukur kemampuan berpikir tingkat tinggi</li>
                            <li>‚Ä¢ Berbasis masalah kontekstual</li>
                            <li>‚Ä¢ Menggunakan stimulus yang menarik</li>
                            <li>‚Ä¢ Tidak routine (tidak hafalan)</li>
                            <li>‚Ä¢ Menggunakan level kognitif C4, C5, C6</li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-semibold text-purple-800 mb-2">Level Kognitif HOTS:</h4>
                        <ul class="text-sm text-gray-700 space-y-1">
                            <li>‚Ä¢ <strong>C4 (Menganalisis):</strong> Memecah informasi</li>
                            <li>‚Ä¢ <strong>C5 (Mengevaluasi):</strong> Menilai dan mengkritik</li>
                            <li>‚Ä¢ <strong>C6 (Mengkreasi):</strong> Membuat sesuatu yang baru</li>
                        </ul>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // DOM Elements
        const form = document.getElementById('questionForm');
        const apiConfigSection = document.getElementById('apiConfigSection');
        const generationOptions = document.getElementById('generationOptions');
        const promptSection = document.getElementById('promptSection');
        const resultsSection = document.getElementById('resultsSection');
        const chatgptPrompt = document.getElementById('chatgptPrompt');
        const generateText = document.getElementById('generateText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        
        // API Elements
        const apiKey = document.getElementById('apiKey');
        const toggleApiKey = document.getElementById('toggleApiKey');
        const model = document.getElementById('model');
        const temperature = document.getElementById('temperature');
        const tempValue = document.getElementById('tempValue');
        const testConnection = document.getElementById('testConnection');
        
        // Generation Elements
        const generateAuto = document.getElementById('generateAuto');
        const generateAutoText = document.getElementById('generateAutoText');
        const generateAutoSpinner = document.getElementById('generateAutoSpinner');
        const showPrompt = document.getElementById('showPrompt');
        const copyPrompt = document.getElementById('copyPrompt');
        
        // Results Elements
        const apiStatus = document.getElementById('apiStatus');
        const statusIcon = document.getElementById('statusIcon');
        const statusTitle = document.getElementById('statusTitle');
        const statusMessage = document.getElementById('statusMessage');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const processResult = document.getElementById('processResult');
        const regenerate = document.getElementById('regenerate');
        const chatgptResult = document.getElementById('chatgptResult');
        const processedQuestions = document.getElementById('processedQuestions');
        const questionsContainer = document.getElementById('questionsContainer');
        const downloadPdf = document.getElementById('downloadPdf');
        const downloadWord = document.getElementById('downloadWord');
        const toggleView = document.getElementById('toggleView');
        const exportJson = document.getElementById('exportJson');

        // Global variables
        let currentFormData = {};
        let isCompactView = false;
        let generatedQuestions = [];

        // Temperature slider
        temperature.addEventListener('input', function() {
            tempValue.textContent = this.value;
        });

        // API Key toggle
        toggleApiKey.addEventListener('click', function() {
            if (apiKey.type === 'password') {
                apiKey.type = 'text';
                this.textContent = 'üôà';
            } else {
                apiKey.type = 'password';
                this.textContent = 'üëÅÔ∏è';
            }
        });

        // Form submission
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const subject = document.getElementById('subject').value;
            const grade = document.getElementById('grade').value;
            const academicYear = document.getElementById('academicYear').value;
            const materialScope = document.getElementById('materialScope').value;
            const mcqCount = document.getElementById('mcqCount').value;
            const essayCount = document.getElementById('essayCount').value;

            if (!subject || !grade || !academicYear || !materialScope) {
                showNotification('Mohon lengkapi semua field yang diperlukan!', 'error');
                return;
            }

            // Store form data
            currentFormData = { subject, grade, academicYear, materialScope, mcqCount, essayCount };

            // Show loading
            generateText.textContent = 'Mempersiapkan...';
            loadingSpinner.classList.remove('hidden');

            // Simulate processing time
            setTimeout(() => {
                generateText.textContent = 'üöÄ Generate Soal HOTS';
                loadingSpinner.classList.add('hidden');
                
                apiConfigSection.classList.remove('hidden');
                generationOptions.classList.remove('hidden');
                resultsSection.classList.remove('hidden');
                
                // Smooth scroll to API config
                apiConfigSection.scrollIntoView({ behavior: 'smooth' });
            }, 1000);
        });

        // Test API Connection
        testConnection.addEventListener('click', async function() {
            const key = apiKey.value.trim();
            if (!key) {
                showNotification('Mohon masukkan API Key terlebih dahulu!', 'error');
                return;
            }

            this.textContent = 'Testing...';
            this.disabled = true;

            try {
                const response = await fetch('https://api.openai.com/v1/models', {
                    headers: {
                        'Authorization': `Bearer ${key}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    showNotification('Koneksi API berhasil! ‚úÖ', 'success');
                    this.textContent = '‚úÖ Koneksi Berhasil';
                    this.classList.remove('bg-purple-600', 'hover:bg-purple-700');
                    this.classList.add('bg-green-600');
                } else {
                    throw new Error('API Key tidak valid');
                }
            } catch (error) {
                showNotification('Koneksi gagal: ' + error.message, 'error');
                this.textContent = '‚ùå Koneksi Gagal';
                this.classList.remove('bg-purple-600', 'hover:bg-purple-700');
                this.classList.add('bg-red-600');
            }

            setTimeout(() => {
                this.textContent = 'üîó Test Koneksi API';
                this.classList.remove('bg-green-600', 'bg-red-600');
                this.classList.add('bg-purple-600', 'hover:bg-purple-700');
                this.disabled = false;
            }, 3000);
        });

        // Generate Automatically
        generateAuto.addEventListener('click', async function() {
            const key = apiKey.value.trim();
            if (!key) {
                showNotification('Mohon masukkan API Key terlebih dahulu!', 'error');
                return;
            }

            const generationMode = document.querySelector('input[name="generationMode"]:checked').value;
            
            if (generationMode === 'manual') {
                showPromptOnly();
                return;
            }

            await generateWithAPI();
        });

        // Show Prompt Only
        showPrompt.addEventListener('click', function() {
            showPromptOnly();
        });

        function showPromptOnly() {
            const prompt = generatePrompt();
            chatgptPrompt.textContent = prompt;
            promptSection.classList.remove('hidden');
            promptSection.scrollIntoView({ behavior: 'smooth' });
        }

        async function generateWithAPI() {
            const key = apiKey.value.trim();
            const selectedModel = model.value;
            const temp = parseFloat(temperature.value);
            
            generateAutoText.textContent = 'Generating...';
            generateAutoSpinner.classList.remove('hidden');
            
            showStatus('loading', 'Menghubungi ChatGPT...', 'Sedang memproses permintaan Anda');
            updateProgress(20);

            try {
                const prompt = generatePrompt();
                
                updateProgress(40);
                showStatus('loading', 'Menghasilkan soal...', 'ChatGPT sedang membuat soal HOTS untuk Anda');

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${key}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: selectedModel,
                        messages: [
                            {
                                role: 'system',
                                content: 'Anda adalah ahli pendidikan yang sangat berpengalaman dalam membuat soal HOTS (Higher Order Thinking Skills) untuk siswa SMP. Buatlah soal yang berkualitas tinggi, kontekstual, dan sesuai kurikulum Indonesia.'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        temperature: temp,
                        max_tokens: 4000
                    })
                });

                updateProgress(80);

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                const result = data.choices[0].message.content;

                updateProgress(100);
                showStatus('success', 'Soal berhasil dihasilkan!', 'ChatGPT telah membuat soal HOTS sesuai spesifikasi Anda');

                chatgptResult.value = result;
                regenerate.classList.remove('hidden');
                
                setTimeout(() => {
                    processQuestions(result);
                    processedQuestions.classList.remove('hidden');
                    downloadPdf.classList.remove('hidden');
                    downloadWord.classList.remove('hidden');
                    
                    hideStatus();
                    processedQuestions.scrollIntoView({ behavior: 'smooth' });
                }, 2000);

            } catch (error) {
                showStatus('error', 'Terjadi kesalahan', error.message);
                showNotification('Error: ' + error.message, 'error');
            }

            generateAutoText.textContent = 'üöÄ Generate Otomatis';
            generateAutoSpinner.classList.add('hidden');
        }

        function generatePrompt() {
            const { subject, grade, academicYear, materialScope, mcqCount, essayCount } = currentFormData;
            const includeExplanation = document.getElementById('includeExplanation').checked;
            const includeRubric = document.getElementById('includeRubric').checked;
            const contextualProblem = document.getElementById('contextualProblem').checked;

            let additionalInstructions = '';
            if (includeExplanation) additionalInstructions += '\n- Sertakan penjelasan detail untuk setiap jawaban';
            if (includeRubric) additionalInstructions += '\n- Berikan rubrik penilaian untuk soal esai';
            if (contextualProblem) additionalInstructions += '\n- Gunakan konteks masalah yang relevan dengan kehidupan di Indonesia';

            return `Saya membutuhkan bantuan untuk membuat soal ujian berbasis HOTS (Higher Order Thinking Skills) dengan detail sebagai berikut:

üìö DATA PEMBELAJARAN:
‚Ä¢ Mata Pelajaran: ${subject}
‚Ä¢ Kelas: ${grade}
‚Ä¢ Tahun Ajaran: ${academicYear}
‚Ä¢ Cakupan Materi: ${materialScope}

üìù SPESIFIKASI SOAL:
‚Ä¢ Jumlah Soal Pilihan Ganda: ${mcqCount} soal
‚Ä¢ Jumlah Soal Esai: ${essayCount} soal

üéØ KRITERIA SOAL HOTS:
1. Soal harus mengukur kemampuan berpikir tingkat tinggi (C4-Menganalisis, C5-Mengevaluasi, C6-Mengkreasi)
2. Berbasis masalah kontekstual dari kehidupan nyata
3. Menggunakan stimulus yang menarik (teks, gambar, grafik, atau kasus)
4. Tidak bersifat hafalan atau routine
5. Melatih logika, berpikir kritis, dan kreativitas siswa${additionalInstructions}

üìã FORMAT OUTPUT:
Untuk Soal Pilihan Ganda:
- Berikan stimulus/konteks yang relevan
- Pertanyaan yang menguji analisis, evaluasi, atau kreasi
- 4 pilihan jawaban (A, B, C, D)
- Kunci jawaban dengan penjelasan mengapa jawaban tersebut benar
- Keterangan level HOTS yang diukur

Untuk Soal Esai:
- Berikan stimulus/konteks yang kompleks
- Pertanyaan terbuka yang membutuhkan analisis mendalam
- Rubrik penilaian dengan kriteria jawaban
- Keterangan level HOTS yang diukur

Mohon buatkan soal-soal tersebut dengan kualitas tinggi dan sesuai dengan kurikulum yang berlaku. Terima kasih!`;
        }

        // Status functions
        function showStatus(type, title, message) {
            apiStatus.classList.remove('hidden');
            statusTitle.textContent = title;
            statusMessage.textContent = message;
            
            apiStatus.className = 'mb-6 p-4 rounded-lg border-l-4';
            
            if (type === 'loading') {
                apiStatus.classList.add('bg-blue-50', 'border-blue-500');
                statusIcon.innerHTML = '<div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>';
                progressBar.classList.remove('hidden');
            } else if (type === 'success') {
                apiStatus.classList.add('bg-green-50', 'border-green-500');
                statusIcon.innerHTML = '<div class="text-green-600 text-xl">‚úÖ</div>';
                progressBar.classList.add('hidden');
            } else if (type === 'error') {
                apiStatus.classList.add('bg-red-50', 'border-red-500');
                statusIcon.innerHTML = '<div class="text-red-600 text-xl">‚ùå</div>';
                progressBar.classList.add('hidden');
            }
        }

        function updateProgress(percent) {
            progressFill.style.width = percent + '%';
        }

        function hideStatus() {
            setTimeout(() => {
                apiStatus.classList.add('hidden');
            }, 3000);
        }

        // Copy prompt functionality
        copyPrompt.addEventListener('click', function() {
            navigator.clipboard.writeText(chatgptPrompt.textContent).then(function() {
                copyPrompt.innerHTML = '‚úÖ Tersalin!';
                copyPrompt.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                copyPrompt.classList.add('bg-green-600');
                
                setTimeout(() => {
                    copyPrompt.innerHTML = 'üìã Salin';
                    copyPrompt.classList.remove('bg-green-600');
                    copyPrompt.classList.add('bg-blue-500', 'hover:bg-blue-600');
                }, 2000);
            });
        });

        // Regenerate functionality
        regenerate.addEventListener('click', function() {
            generateWithAPI();
        });

        // Process results
        processResult.addEventListener('click', function() {
            const result = chatgptResult.value.trim();
            if (!result) {
                showNotification('Mohon isi hasil dari ChatGPT terlebih dahulu!', 'error');
                return;
            }

            processQuestions(result);
            processedQuestions.classList.remove('hidden');
            downloadPdf.classList.remove('hidden');
            downloadWord.classList.remove('hidden');
            
            processedQuestions.scrollIntoView({ behavior: 'smooth' });
        });

        function processQuestions(text) {
            questionsContainer.innerHTML = '';
            generatedQuestions = [];
            
            // Enhanced processing - better parsing
            const sections = text.split(/(?=\d+\.|\n\n(?=\w))/);
            let mcqCount = 0;
            let essayCount = 0;
            
            sections.forEach((section, index) => {
                if (section.trim()) {
                    const questionCard = document.createElement('div');
                    questionCard.className = 'question-card bg-gray-50 rounded-lg p-6 border-l-4 border-indigo-500';
                    
                    // Determine question type
                    const isMultipleChoice = section.includes('A.') || section.includes('a)') || section.includes('A)');
                    if (isMultipleChoice) {
                        mcqCount++;
                        questionCard.classList.add('border-green-500');
                    } else {
                        essayCount++;
                        questionCard.classList.add('border-purple-500');
                    }
                    
                    const questionContent = document.createElement('div');
                    questionContent.className = 'whitespace-pre-wrap text-gray-800';
                    questionContent.textContent = section.trim();
                    
                    questionCard.appendChild(questionContent);
                    questionsContainer.appendChild(questionCard);
                    
                    generatedQuestions.push({
                        type: isMultipleChoice ? 'multiple_choice' : 'essay',
                        content: section.trim()
                    });
                }
            });
            
            // Update statistics
            document.getElementById('totalQuestions').textContent = generatedQuestions.length;
            document.getElementById('mcqCount').textContent = mcqCount;
            document.getElementById('essayCount').textContent = essayCount;
        }

        // Toggle view
        toggleView.addEventListener('click', function() {
            isCompactView = !isCompactView;
            const cards = document.querySelectorAll('.question-card');
            
            if (isCompactView) {
                cards.forEach(card => {
                    card.classList.add('p-3');
                    card.classList.remove('p-6');
                    const content = card.querySelector('div');
                    content.classList.add('text-sm');
                });
                this.textContent = 'üëÅÔ∏è Tampilan Normal';
            } else {
                cards.forEach(card => {
                    card.classList.add('p-6');
                    card.classList.remove('p-3');
                    const content = card.querySelector('div');
                    content.classList.remove('text-sm');
                });
                this.textContent = 'üëÅÔ∏è Tampilan Kompak';
            }
        });

        // Export JSON
        exportJson.addEventListener('click', function() {
            const exportData = {
                metadata: currentFormData,
                questions: generatedQuestions,
                generated_at: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `Soal_HOTS_${currentFormData.subject}_${new Date().toISOString().slice(0,10)}.json`;
            link.click();
            
            showNotification('Data soal berhasil diekspor ke JSON!', 'success');
        });

        // Download functions
        downloadPdf.addEventListener('click', function() {
            const content = formatForDownload();
            const link = document.createElement('a');
            link.href = 'data:text/plain;charset=utf-8,' + encodeURIComponent(content);
            link.download = `Soal_HOTS_${currentFormData.subject}_${new Date().toISOString().slice(0,10)}.txt`;
            link.click();
            
            showNotification('File PDF sedang dipersiapkan untuk download!', 'success');
        });

        downloadWord.addEventListener('click', function() {
            const content = formatForDownload();
            const link = document.createElement('a');
            link.href = 'data:text/plain;charset=utf-8,' + encodeURIComponent(content);
            link.download = `Soal_HOTS_${currentFormData.subject}_${new Date().toISOString().slice(0,10)}.doc`;
            link.click();
            
            showNotification('File Word sedang dipersiapkan untuk download!', 'success');
        });

        function formatForDownload() {
            const { subject, grade, academicYear, materialScope } = currentFormData;
            let content = `SOAL UJIAN BERBASIS HOTS\n`;
            content += `Mata Pelajaran: ${subject}\n`;
            content += `Kelas: ${grade}\n`;
            content += `Tahun Ajaran: ${academicYear}\n`;
            content += `Cakupan Materi: ${materialScope}\n`;
            content += `Tanggal Generate: ${new Date().toLocaleDateString('id-ID')}\n`;
            content += `\n${'='.repeat(50)}\n\n`;
            content += chatgptResult.value;
            return content;
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9939ae4360849b9d',t:'MTc2MTMxMTA3NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
